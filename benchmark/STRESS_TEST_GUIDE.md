# GearEngine 压力测试指南

本指南介绍如何使用压力测试工具对 GearEngine 聊天服务器进行性能测试。

## 快速开始

### 1. 启动服务器

首先启动聊天服务器：

```bash
cd server
./ge.exe 8080 chat_server.lua
```

### 2. 构建压力测试工具

压力测试工具会在构建主项目时自动构建：

```bash
cd ge
./build-msys2.sh  # Windows MSYS2
# 或
./build-linux.sh  # Linux
```

### 3. 运行压力测试

```bash
cd benchmark
# Windows
..\ge\build\bin\stress_client.exe 100 10 100 localhost 8080

# Linux/MSYS2
../ge/build/bin/stress_client 100 10 100 localhost 8080
```

## 测试场景

### 场景1：基础连接测试

测试服务器能同时处理多少个连接：

```bash
# 100个客户端，每个发送10条消息，间隔100ms
./stress_client 100 10 100

# 500个客户端
./stress_client 500 10 100

# 1000个客户端
./stress_client 1000 10 100
```

**观察指标：**
- 连接成功率（应该 > 95%）
- 连接建立时间
- 服务器响应时间

### 场景2：消息吞吐量测试

测试服务器每秒能处理多少消息：

```bash
# 100个客户端，每个发送100条消息，间隔10ms（高频率）
./stress_client 100 100 10

# 500个客户端，每个发送50条消息，间隔20ms
./stress_client 500 50 20
```

**观察指标：**
- 消息吞吐量（每秒消息数）
- 消息丢失率
- 服务器CPU和内存使用率

### 场景3：长时间稳定性测试

测试服务器长时间运行的稳定性：

```bash
# 100个客户端，每个发送1000条消息，间隔100ms
./stress_client 100 1000 100
```

**观察指标：**
- 内存泄漏
- 连接稳定性
- 错误率变化

### 场景4：突发流量测试

模拟突发流量场景：

```bash
# 快速连接大量客户端，然后快速发送消息
./stress_client 1000 20 5  # 1000个客户端，快速发送
```

## 性能指标解读

### 连接成功率

```
Successful connections: 980 / 1000 (98%)
```

- **> 95%**: 优秀
- **90-95%**: 良好
- **< 90%**: 需要优化

### 消息吞吐量

```
Messages per second: 850.50
```

根据服务器配置和硬件，合理的吞吐量范围：
- **小型服务器**: 100-500 msg/s
- **中型服务器**: 500-2000 msg/s
- **大型服务器**: 2000+ msg/s

### 错误率

```
Errors: 5
```

错误应该尽可能少：
- **0-1%**: 优秀
- **1-5%**: 可接受
- **> 5%**: 需要调查

## 性能优化建议

根据测试结果，可以采取以下优化措施：

### 1. 连接数不足

**症状**: 连接成功率低，大量连接失败

**解决方案**:
- 检查服务器最大连接数限制
- 增加系统文件描述符限制
- 优化连接处理逻辑

### 2. 消息丢失

**症状**: 发送的消息数 > 接收的消息数

**解决方案**:
- 增加消息队列大小
- 优化消息广播逻辑
- 检查网络缓冲区

### 3. 高延迟

**症状**: 消息响应时间长

**解决方案**:
- 优化Lua脚本性能
- 减少不必要的消息处理
- 使用更高效的算法

### 4. 内存泄漏

**症状**: 长时间运行后内存持续增长

**解决方案**:
- 检查客户端连接清理
- 检查Lua状态管理
- 使用内存分析工具

## 自动化测试

使用提供的测试脚本可以运行多个测试场景：

```bash
# Windows
run_stress_test.bat

# Linux/MSYS2
chmod +x run_stress_test.sh
./run_stress_test.sh
```

## 监控建议

在运行压力测试时，建议同时监控：

1. **服务器日志** - 查看错误和警告
2. **系统资源** - CPU、内存、网络使用率
3. **连接数** - 使用 `netstat` 或 `ss` 命令
4. **进程状态** - 使用 `top` 或 `htop`

## 故障排除

### 问题：无法连接到服务器

**检查**:
- 服务器是否运行
- 端口是否正确
- 防火墙设置

### 问题：测试工具崩溃

**检查**:
- 系统资源是否充足
- 减少并发连接数
- 检查是否有内存泄漏

### 问题：测试结果异常

**检查**:
- 网络是否稳定
- 服务器负载是否过高
- 是否有其他程序占用资源

## 最佳实践

1. **逐步增加负载** - 从少量客户端开始，逐步增加
2. **多次测试** - 运行多次测试取平均值
3. **记录结果** - 保存测试结果以便对比
4. **监控资源** - 同时监控服务器和客户端资源
5. **分析瓶颈** - 根据测试结果找出性能瓶颈
